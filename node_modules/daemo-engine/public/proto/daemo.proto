syntax = "proto3";
package daemo;

// Service for the .NET SDK to connect to the self-hosted Daemo Engine
service DaemoGateway {
  // RENAMED from Connect to avoid naming conflict with the client's built-in connect method.
  rpc EstablishStream(stream ServiceMessage) returns (stream GatewayMessage);
}

// Service for applications to communicate with the Daemo AI Agent
service DaemoAgent {
  // --- Query Processing ---
  rpc ProcessQuery(QueryRequest) returns (QueryResponse);

  // --- Streaming Query Processing ---
  rpc ProcessQueryStreamed(QueryRequest) returns (stream QueryStreamResponse);

  // --- Thread Management ---
  rpc CreateThread(CreateThreadRequest) returns (CreateThreadResponse);
  rpc ListThreads(ListThreadsRequest) returns (ListThreadsResponse);
  rpc GetThread(GetThreadRequest) returns (GetThreadResponse);
  rpc DeleteThread(DeleteThreadRequest) returns (DeleteThreadResponse);
}

// ===================================================================
// Gateway Streaming Messages (SDK <-> Engine)
// ===================================================================

// Message from the Service/SDK to the Gateway.
message ServiceMessage {
  oneof message {
    AuthenticateRequest auth = 1;
    RegisterRequest register = 2;
    FunctionResponse function_response = 3;
    Heartbeat heartbeat = 4;
  }
}

// Message from the Gateway to the Service/SDK.
message GatewayMessage {
  oneof message {
    AuthenticationResult auth_result = 1;
    FunctionRequest function_request = 2;
    Heartbeat heartbeat = 3;
  }
}

message AuthenticateRequest {
  string agent_api_key = 1;
}

message AuthenticationResult {
  bool success = 1;
  string message = 2;
  string agent_id = 3; // The authenticated agent's ID.
}

// SDK sends its function definitions to be stored in the registry.
message RegisterRequest {
  string session_json = 1;
}

// Gateway sends a request for the SDK to execute a function.
message FunctionRequest {
  string request_id = 1;
  string function_name = 2;
  string input_json = 3;
  optional string role = 4;
  optional string context_json = 5;
}

// SDK sends the result of a function execution back to the Gateway.
message FunctionResponse {
  string request_id = 1;
  bool success = 2;
  string result_json = 3;
  string error_message = 4;
}

message Heartbeat {
  int64 timestamp = 1;
}

// ===================================================================
// Agent Service Messages (for unary calls)
// ===================================================================

message LlmConfig {
  string provider = 1;
  optional string api_key = 2;
  optional string endpoint = 3;
  optional string model = 4;
  optional uint32 max_tokens = 5;
}

message MongoDbConfig {
  string connection_string = 1;
  string database_name = 2;
}

message LocalFileConfig {
  optional string base_path = 1;
}

message StorageConfig {
  oneof config {
    MongoDbConfig mongodb = 1;
    LocalFileConfig local_file = 2;
  }
}

message QueryRequest {
  string query = 1;
  optional string thread_id = 2;
  optional string session_id = 3;
  optional LlmConfig llm_config = 4;
  optional StorageConfig storage_config = 5;
  optional string role = 6;
  optional string context_json = 7;
  optional bool analysis_mode = 8;
}

message ToolCallInfo {
    string tool_name = 1;
    string parameters_json = 2;
    optional string result_json = 3;
    bool success = 4;
    optional string error_message = 5;
    int64 execution_time_ms = 6;
    optional string id = 7;
    optional string timestamp = 8;
}

message QueryResponse {
  bool success = 1;
  string response = 2;
  string error_message = 3;
  string thread_id = 4;
  repeated ToolCallInfo tool_interactions = 5;
  int64 execution_time_ms = 6;
}

message QueryStreamResponse {
  oneof event {
    string thought = 1;
    ToolCallInfo tool_call = 2;
    ToolCallInfo tool_result = 3;
    string partial_response_chunk = 4;
    QueryResponse final_response = 5;
    string error = 6;
  }
}

message CreateThreadRequest {
  optional string session_id = 1;
  optional StorageConfig storage_config = 2;
}

message CreateThreadResponse {
  bool success = 1;
  string thread_id = 2;
  string error_message = 3;
}

message ThreadInfo {
    string thread_id = 1;
    string created_at = 2;
    string updated_at = 3;
    int32 message_count = 4;
    int32 data_count = 5;
    int64 memory_size_bytes = 6;
    optional string session_id = 7;
    optional string last_user_message = 8;
}

message ListThreadsRequest {
    optional string session_id = 1;
    optional StorageConfig storage_config = 2;
}

message ListThreadsResponse {
    bool success = 1;
    repeated ThreadInfo threads = 2;
    string error_message = 3;
}

message GetThreadRequest {
    string thread_id = 1;
    optional StorageConfig storage_config = 2;
}

message ThreadMessageInfo {
    string id = 1;
    string timestamp = 2;
    string role = 3;
    string content = 4;
    repeated ToolCallInfo tool_calls = 5;
}

message GetThreadResponse {
    bool success = 1;
    optional ThreadInfo thread_info = 2;
    repeated ThreadMessageInfo recent_messages = 3;
    string error_message = 4;
}

message DeleteThreadRequest {
    string thread_id = 1;
    optional StorageConfig storage_config = 2;
}

message DeleteThreadResponse {
    bool success = 1;
    string error_message = 2;
}
